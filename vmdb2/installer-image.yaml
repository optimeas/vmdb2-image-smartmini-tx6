# Copyright (C) 2021  optiMEAS GmbH. All rights reserved.
#
# SPDX-License-Identifier: GPL-2.0-only

steps:
  - mkimg: "{{ output }}"
    size: 2000M

  - mklabel: msdos
    device: "{{ output }}"

  - mkpart: primary
    device: "{{ output }}"
    start: 0%
    end: 100%
    tag: /

  - kpartx: "{{ output }}"

  - mkfs: ext4
    partition: /
    label: OMINSTALL
    options: -FO ^64bit,^metadata_csum

  - mount: /

  - unpack-rootfs: /
  - qemu-debootstrap: bullseye
    mirror: http://deb.debian.org/debian
    target: /
    variant: minbase
    arch: armhf
    components:
    - main
    - contrib
    - non-free
    unless: rootfs_unpacked

  - create-file: /etc/apt/sources.list
    trailing-newline: '1'
    contents: |
      deb http://deb.debian.org/debian bullseye main contrib non-free
      deb http://deb.debian.org/debian-security/ bullseye-security main contrib non-free
      deb http://deb.debian.org/debian bullseye-updates main contrib non-free      
    unless: rootfs_unpacked

  - fstab: /
  
  - chroot: /
    shell: |
      apt-get update
    unless: rootfs_unpacked

  - apt: install
    packages:
    - parted
    tag: /
    unless: rootfs_unpacked

  - cache-rootfs: /
    unless: rootfs_unpacked
  
  - shell: |
      echo "smartmini" > "${ROOT?}/etc/hostname"
      echo "127.0.0.1    smartmini" >> "${ROOT?}/etc/hosts"

      install -m 644 -o root -g root debian-packages/linux-image-*.deb "${ROOT?}/linux-image.deb"

      # target rootfs and installer script
      install -m 644 -o root -g root installer/rootfs.tar.gz "${ROOT?}/rootfs.tar.gz"
      install -m 755 -o root -g root installer/init-install "${ROOT?}/usr/sbin/init-install"

      # U-Boot
      install -m 644 -o root -g root installer/u-boot.scr "${ROOT?}/boot/u-boot.scr"  
    root-fs: /

  - chroot: /
    shell: |
      dpkg --install /linux-image.deb
      rm /linux-image.deb
      
      ln -s /boot/vmlinuz-* /boot/zImage
      
      cp /usr/lib/linux-image*/imx6dl-tx6s-8035-smartmini-v2p1.dtb /boot/tx6s-8035-smartmini-v2p1.dtb      
      cp /usr/lib/linux-image*/imx6dl-tx6s-8035-smartmini-v2p2.dtb /boot/tx6s-8035-smartmini-v2p2.dtb
      cp /usr/lib/linux-image*/imx6dl-tx6s-8035-smartmini-v2p3.dtb /boot/tx6s-8035-smartmini-v2p3.dtb
      cp /usr/lib/linux-image*/imx6q-tx6qp-8037-smartmini-v2p1.dtb /boot/tx6qp-8037-smartmini-v2p1.dtb
      cp /usr/lib/linux-image*/imx6q-tx6qp-8037-smartmini-v2p3.dtb /boot/tx6qp-8037-smartmini-v2p3.dtb
      cp /usr/lib/linux-image*/imx6dl-tx6s-8035-smartpro-v1p2.dtb  /boot/tx6s-8035-smartpro-v1p2.dtb
      cp /usr/lib/linux-image*/imx6dl-tx6s-8035-smartrail-v1p0.dtb /boot/tx6s-8035-smartrail-v1p0.dtb
      cp /usr/lib/linux-image*/imx6q-tx6qp-8037-smartrail-v1p0.dtb /boot/tx6qp-8037-smartrail-v1p0.dtb
      cp /usr/lib/linux-image*/imx6dl-tx6u-8033-bekolog-v1p0.dtb   /boot/tx6u-8033-bekolog-v1p0.dtb

  # Clean up archive cache (likely not useful) and lists (likely outdated) to
  # reduce image size by several hundred megabytes.
  - chroot: /
    shell: |
      apt-get clean
      rm -rf /var/lib/apt/lists

  # TODO(https://github.com/larswirzenius/vmdb2/issues/24): remove once vmdb
  # clears /etc/resolv.conf on its own.
  - shell: |
      rm "${ROOT?}/etc/resolv.conf"
    root-fs: /